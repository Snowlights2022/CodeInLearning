function Folder(folderDescription, hreference) //constructor
{
  //constant data
  this.desc = folderDescription
  this.hreference = hreference
  this.id = -1
  this.navObj = 0
  this.children = new Array
  this.nChildren = 0
  this.level = 0
  this.leftSideCoded = ""

  //dynamic data
  this.isOpen = false
  this.isRendered = 0
  this.rendernow = 0
  
  //menuflag
  this.menuflag = -1
  
  //methods
  this.initialize = initializeFolder
  this.setState = setStateFolder
  this.addChild = addChild
  this.createIndex = createEntryIndex
  this.escondeBlock = escondeBlock
  this.esconde = escondeFolder
  this.mostra = mostra
  this.renderOb = drawFolder
  this.totalHeight = totalHeight
  this.subEntries = folderSubEntries
  this.blockStartHTML = blockStartHTML
  this.blockEndHTML = blockEndHTML
  this.subLayerStart = subLayerStart
}

function initializeFolder(level, leftSide)
{
  var j=0
  var i=0
  nc = this.nChildren

  this.createIndex()
  this.level = level
  this.leftSideCoded = leftSide

  if (browserVersion == 0)
    this.isOpen=true;

  if (level > 1)
    leftSide = leftSide + "0"

  if (nc > 0)
  {
    level = level + 1
    for (i=0 ; i < this.nChildren; i++)
    {
        this.children[i].initialize(level, leftSide)
    }
  }
}

function drawFolder()
{
  var docW = ""
  var leftSide = leftSideHTML(this.leftSideCoded)

  this.isRendered = 1

  if ( this.level > 0){
	  if ( this.level == 1){
	  	docW = docW + "<td id=f" + this.id ;
			if ( /*browsernetscape ==*/ 1 )
		  	docW = docW + " style='background-color:#EF8218'";
			else
		  	docW = docW + " background='pic/bg_firstmenu_orange.jpg'";
	  	docW = docW + " align=middle class=Fstmenutd>";
	  	docW = docW + "<a class='Fstmenuoff'  href='" + this.hreference + "' target='mainFrame' ";
	  	if (browserVersion > 0)
		  	docW = docW + " onClick='javascript:ClickonFristFolder(" + this.id + ",\"" + this.desc + "\")'";
	  	docW = docW + ">" + this.desc + "</a>";
	  	docW = docW + "</td>"
	  	}
	  else if ( this.level == 2){
	  	docW = docW + "<td id=s" + this.id ;
	  	docW = docW + " class=Secmenutd>";
	  	docW = docW + "<a class=Secmenuoff  href='" + this.hreference + "' target='mainFrame' ";
	  	if (browserVersion > 0)
		  	docW = docW + " onClick='javascript:ClickonFristFolder(" + this.id + ")'";
	  	docW = docW + ">" + this.desc + "</a>";
	  	docW = docW + "</td>"
	  	}
	  else if ( this.level > 2){
	  	docW = this.blockStartHTML("folder");
	  	docW = docW + "<tr>";
	  	docW = docW + "<td id=" + this.id + " ";
	  	docW = docW + " align=\"right\">";
	  	docW = docW + "<a class=Thdmenuoff  href='" + this.hreference + "' target='mainFrame' ";
	  	if (browserVersion > 0)
		  	docW = docW + " onClick='javascript:ClickonFristFolder(" + this.id + ")'";
	  	docW = docW + ">" + leftSide + this.desc + "</a>";
	  	docW = docW + "</td>"
	  	docW = docW + "</tr>"
	  	docW = docW + this.blockEndHTML()
	  	}
  	}
	return docW
}

function StartLayerHTML(idprefix) {
  var idParam = "id='" + idprefix + this.id + "'"
  var docW = ""

  if (browserVersion == 2)
    docW = "<layer "+ idParam + " top=" + doc.yPos + " >"
  else if (browserVersion == 1)
    docW = "<div " + idParam + " >"

  return docW
}

function StartMenuLayer(idprefix) {
  var idParam = "id='" + idprefix + "'"
  var docW = ""

  if (browserVersion == 2)
    docW = "<layer "+ idParam + " top=" + doc.yPos + " >"
  else if (browserVersion == 1)
    docW = "<div " + idParam + " >"

  return docW
}

function EndLayerHTML() {
  var docW = ""

  if (browserVersion == 2)
    docW = docW + "</layer>"
  else if (browserVersion == 1)
    docW = docW + "</div>"

  return docW
}

function subLayerStart(idprefix)  //Secmenu or Thdmenu
{
	var idParam = "id='" + idprefix + this.id + "'style='text-align:left;'"
  var docW = ""


	if (idprefix == "Secmenu"){
  if (browserVersion == 2)
    docW = "<layer "+ idParam + " top=" + doc.yPos + " >"
  else if (browserVersion == 1)
    docW = "<div " + idParam + " >"
    
		docW = docW + "<table cellSpacing=0 cellPadding=0 border=0 frame=\"void\">"
		docW = docW + "<tbody>"
		docW = docW + "<tr align=\"center\" valign=\"bottom\" bgcolor=#427594>"
	}
	else if (0/*idprefix == "Thdmenu"*/){
		docW = docW + "<tr " + idParam + "><TD>"
		docW = docW + "<table class=Thdmenu cellSpacing=1 cellPadding=0 border=0>"
		docW = docW + "<tbody>"
	}

	return docW
}

function subLayerEnd(idprefix) 
{
  var docW = ""
	if (idprefix == "Secmenu"){
		docW = docW + "<td>&nbsp;</td>"
		docW = docW + "</tr>"
		docW = docW + "</tbody></table>"
	
	  if (browserVersion == 2)
	    docW = docW + "</layer>"
	  else if (browserVersion == 1)
	    docW = docW + "</div>"
	}else{
		docW = docW + "</tbody></table></td></tr>"		
	}

  return docW
}

function setStateFolder(isOpen)
{
  var subEntries
  var totalHeight
  var fIt = 0
  var i=0
  var currentOpen

  if (isOpen == this.isOpen)
    return

  if (browserVersion == 2 && this.level > 2)
  {
    totalHeight = 0
    for (i=0; i < this.nChildren; i++)
      totalHeight = totalHeight + this.children[i].navObj.clip.height
      subEntries = this.subEntries()
    if (this.isOpen)
      totalHeight = 0 - totalHeight
    for (fIt = this.id + subEntries + 1; fIt < nEntries; fIt++)
      indexOfEntries[fIt].navObj.moveBy(0, totalHeight)
  }
  this.isOpen = isOpen;

  propagateChangesInState(this)
}

function propagateChangesInState(folder)
{
  var i=0
  
  for (i=folder.nChildren-1; i>=0; i--)
    if (folder.isOpen)
      folder.children[i].mostra()
    else
      folder.children[i].esconde()
}

function escondeFolder()
{
  this.escondeBlock()
  this.setState(0)
}

function addChild(childNode)
{
  this.children[this.nChildren] = childNode
  this.nChildren++
  return childNode
}

function folderSubEntries()
{
  var i = 0
  var se = this.nChildren

  for (i=0; i < this.nChildren; i++){
    if (this.children[i].children) //is a folder
      se = se + this.children[i].subEntries()
  }

  return se
}

// Methods common to both objects (pseudo-inheritance)
//hiden object
function escondeBlock()
{
  var NAVObj = this.navObj;
  if (browserVersion == 1) {
      NAVObj.style.display = "none"
  } else {
      NAVObj.visibility = "hiden"
  }
}

//show object
function mostra()
{
	var NAVObj = this.navObj;
		
  if (!this.isRendered)
     this.renderOb()
  else
    if (browserVersion == 1){
      NAVObj.style.display = "block";
      switch (deviceType){
        case "1":
        case "2":
        case "3":
        case "4":
        case "5":
          var jobj=$(NAVObj);
            if(jobj.find("a[href='DD_Business.html']")){
              jobj.find("a[href='DD_Business.html']").css({display:"none"});
            }
          break;
        case "6":
        case "7":
        case "8":
        case "9":
        case "10":
        case "11":
          break;
        default :
          break;
      }
    }
    else
      NAVObj.visibility = "show"
}

function blockStartHTML(idprefix) {
  var idParam = "id='" + idprefix + this.id + "' "
  var docW = ""

  if (browserVersion == 2)
    docW = "<layer "+ idParam + " top=" + doc.yPos + " >"
  else if (browserVersion == 1)
    docW = "<div " + idParam + " class='thdiv' >"

  docW = docW + "<TABLE class=Thdmenu cellSpacing=1 cellPadding=0 border=0>"
  docW = docW + "<TBODY>"

  return docW
}

function blockEndHTML() {
  var docW = ""

  docW = "</tbody>"
  docW = docW + "</table>"

  if (browserVersion == 2)
    docW = docW + "</layer>"
  else if (browserVersion == 1)
    docW = docW + "</div>"

  return docW
}

function createEntryIndex()
{
  this.id = nEntries
  indexOfEntries[nEntries] = this
  nEntries++
}

// total height of subEntries open
function totalHeight() //used with browserVersion == 2
{
  var h = this.navObj.clip.height
  var i = 0

  if (this.isOpen) //is a folder and _is_ open
    for (i=0 ; i < this.nChildren; i++)
      h = h + this.children[i].totalHeight()

  return h
}

function leftSideHTML(leftSideCoded) {
    var i;
    var retStr = "";

    for (i=1; i<leftSideCoded.length; i++)
    {
        if (leftSideCoded.charAt(i) == "0")
        {
            retStr = retStr + "&nbsp;&nbsp;&nbsp;"
        }
    }
    return retStr
}

// Events
function ClickonFristFolder(folderId,folderdesc)
{
    var clicked = indexOfEntries[folderId]

    changebg(folderId,clicked);

    // open only current folder, and close other siblings
    var folder;
    for ( i = 1; i < nEntries; i++ ) {
        folder = indexOfEntries[i];
        if ( clicked.level == folder.level &&
             folder.isOpen == true ) {
            folder.setState(false);
            break;
        }
    }
    clicked.setState(true)
    if (clicked.level < 2)
    	clicked.children[0].setState(true)
    if (clicked.level == 1)
    document.getElementById('LocationDisplay').innerHTML = folderdesc;	    
}

//change background images or background color 
function changebg(changedid,nodeclicked){
  for ( i = 1; i < nEntries; i++ ){
    var changed = indexOfEntries[i]; 
    if (i==changedid){
      if (changed.level == 1){
        if ( /*browsernetscape ==*/ 1 ) {
			$('#f'+changed.id).css('backgroundColor', '#427594').children('a').addClass('selected');
         // getElById("f" + changed.id).bgColor= "#427594";
		} else
          getElById("f" + changed.id).background="pic/bg_firstmenu_blue.jpg";					
      }
      else if (changed.level == 2 ){
		$('#s'+changed.id).children('a').addClass('selected');
       // getElById("s" + changed.id).bgColor= "#E7E7E7"	;
      }
      else if (changed.level > 2 ){
        if ( /*browsernetscape ==*/ 1 )
		  $('#'+changed.id).children('a').addClass('selected');
         // getElById(changed.id).bgColor= ""	;
        else
          getElById(changed.id).background="pic/bg_thirdmenu_on.jpg";										
      }				
    }
    else if ((changed.level == nodeclicked.level)||(changed.level > nodeclicked.level)){
      if (changed.level == 1 ){
        if ( /*browsernetscape ==*/ 1 ) {
			$('#f'+changed.id).css('backgroundColor', '#EF8218').children('a').removeClass('selected');
			//getElById("f" + changed.id).bgColor= "#EF8218";
		} else
          getElById("f" + changed.id).background="pic/bg_firstmenu_orange.jpg";					
      }
      else if (changed.level == 2){
		  
		  $('#s'+changed.id).children('a').removeClass('selected');
        //getElById("s" + changed.id).bgColor= ""	;
      }
      else if (changed.level > 2){
        if ( /*browsernetscape ==*/ 1 )
			$('#'+changed.id).children('a').removeClass('selected');
          //getElById(changed.id).bgColor= ""	;
        //else
        //  getElById(changed.id).background="pic/bg_thirdmenu_off.jpg";										
      }	
	  			
    }
  }
}

// Auxiliary Functions
function gFld(description, hreference)
{
  folder = new Folder(description, hreference)
  return folder
}

function insFld(parentFolder, childFolder)
{
  return parentFolder.addChild(childFolder)
}

var docWA = ""; //
var docWF = ""; // for frist menu
var docWS = ""; // for seconde menu
var docWT = ""; // for third menu and over

function renderAllTree(nodeObj,flag) {
  var i=0;
      
	//which level
	var docW = "";
	
	if(flag == "0")
	{
		nodeObj.rendernow = 1;
		docWF += StartMenuLayer("Fstmenu");
		docWF += "<table  class=Fstmenu cellSpacing=0 cellPadding=0 width=644 border=0 frame=\"none\">";
		docWF += "<tbody>";
		docWF += "<tr>";

	  for (i=0 ; i < nodeObj.nChildren; i++) {
		  if ( nodeObj.children[i].rendernow != 1 ){
		      nodeObj.children[i].rendernow = 1 ;
		      renderAllTree(nodeObj.children[i],"frist")
		  } 
	  }
		/*var j=7-nodeObj.nChildren;
	  for ( ; j > 0; j--)
	  {
	  	docWF += "<td background='pic/bg_firstmenu_orange.jpg' align=middle class=Fstmenutd></td>"
	  }*/
	
		docWF += "<td bgcolor='#EF8218'>&nbsp;</td>";
		docWF += "</tr>";
		docWF += "</tbody>";
		docWF += "</table>";
		docWF += EndLayerHTML();
	}
	else if (flag == "frist") 
	{
		docWF += nodeObj.renderOb();
		nodeObj.rendernow = 1;

		docWS += nodeObj.subLayerStart("Secmenu");
	  for (i=0 ; i < nodeObj.nChildren; i++) {
	  	if (i != 0 && i %8 == 0){
		  	docWS += "</tr>"
		  	docWS += "<tr height=20 align=middle bgcolor=#427594>"
	  	}
		  if ( nodeObj.children[i].rendernow != 1 ){
		      nodeObj.children[i].rendernow = 1 ;
	      	renderAllTree(nodeObj.children[i],"second");
		  }
	  }
	  if (i < 8)
			docWS += "<td>&nbsp;</td>";
		docWS += "</tr>";
		docWS += "</tbody>";
		docWS += "</table>";
		docWS += EndLayerHTML();
	}
	else if (flag == "second") 
	{

		docWS += nodeObj.renderOb();
		nodeObj.rendernow = 1;

	  for (i=0 ; i < nodeObj.nChildren; i++){
		  if ( nodeObj.children[i].rendernow != 1 ){
		      nodeObj.children[i].rendernow = 1 ;
		      renderAllTree(nodeObj.children[i],"third");
		  }
	  } 
	}
	else if (flag == "third") 
	{
		docWT += nodeObj.renderOb();
		nodeObj.rendernow = 1;

	  for (i=0 ; i < nodeObj.nChildren; i++){
		  if ( nodeObj.children[i].rendernow != 1 ){
		      nodeObj.children[i].rendernow = 1 ;
					renderAllTree(nodeObj.children[i],"third");
		  }
	  } 
	}

}

function hideWholeTree(nodeObj, hideThisOne, nodeObjMove) {
  var i=0;
  var heightContained=0;
  var childrenMove=nodeObjMove;

  if (hideThisOne)
    nodeObj.escondeBlock()

  if (browserVersion == 2)
    nodeObj.navObj.moveBy(0, 0-nodeObjMove)

  for (i=0 ; i < nodeObj.nChildren; i++) {
    heightContainedInChild = hideWholeTree(nodeObj.children[i], true, childrenMove)
    if (browserVersion == 2) {
      heightContained = heightContained + heightContainedInChild + nodeObj.children[i].navObj.clip.height
      childrenMove = childrenMove + heightContainedInChild
    }
  }

  return heightContained;
}

function getElById(idVal) {
  if (document.getElementById != null)
    return document.getElementById(idVal)
  if (document.all != null)
    return document.all[idVal]
  
  alert("Problem getting element by id")
  return null
}

//Other variables
indexOfEntries = new Array
nEntries = 0
browserVersion = 0 
doc = document
doc.yPos = 0
browsernetscape = 0

//set all nodes's navObj
function setallnavobj(nodeObj,parentid)
{
  var idparam = ""
  if ( nodeObj.level == 0){
    idparam = "topLayer"
  }
  else if ( nodeObj.level == 1){
    idparam = "Fstmenu"
  }
  else if ( nodeObj.level == 2){
    idparam = "Secmenu" + parentid
  }
  else {
    idparam = "folder" + nodeObj.id
  }
  
  if (browserVersion == 1){
    nodeObj.navObj = getElById(idparam)
  }
  else if (browserVersion == 2){
    nodeObj.navObj = doc.layers[idparam]
    if (nodeObj.level > 2)
      doc.yPos=doc.yPos+nodeObj.navObj.clip.height
  }
  
  for (var i=0 ; i < nodeObj.nChildren; i++) {
    setallnavobj(nodeObj.children[i],nodeObj.id)
  }
}

// Main function
function initializeDocument()
{
  var docW = "";
  xbDetectBrowser();
  
  foldersTree.initialize(0, "0");
  renderAllTree(foldersTree,"0");
  
  docW = docW + docWA + "";
  /*the frist menu*/    
  docW += docWF + "";
  docW += "";
  docW += "</td></tr><tr><td colspan=2>";
  //the second menu
  docW += StartMenuLayer("Secmenu");
  docW += docWS + "";
  docW += EndLayerHTML();
  
  docW += "</td></tr></tbody></table>";
  docW += EndLayerHTML();
  
  docW += "<table cellSpacing=0 cellPadding=0 width=808 border=0>";
	docW += "<tbody>";
	docW += "<tr>";
	docW += "<td width=156 bgcolor='#E7E7E7'></td>";
	docW += "<td width=3 bgcolor='#E7E7E7'></td>";
	docW += "<td width=5 background='./pic/panelx.gif'></td>";
	docW += "<td height=9' bgcolor=#E7E7E7 width=645 background='./pic/panelx.gif'></td></tr>";
	docW += "<tr id='trmain'>";
	docW += "<td  bgcolor=#E7E7E7 vAlign=top align=right width=156><br />";
	docW += "";
	
	//the third menu
	docW += docWT + "";
	
	doc.write(docW);
	setallnavobj(foldersTree);
	
	if (browserVersion != 0)
    hideWholeTree(foldersTree, false, 0)
    
  if (browserVersion == 2)
    doc.write("<layer top=" + indexOfEntries[nEntries-1].navObj.top + ">&nbsp;</layer>")
    
  if (browserVersion != 0) {
    var clickedFolder
    clickedFolder = indexOfEntries[0]
    changebg(clickedFolder.children[0].id,clickedFolder.children[0])  //Main Page status( first level one background pic's color is blue)
    clickedFolder.setState(true);
    clickedFolder.children[0].setState(true)
    clickedFolder.children[0].children[0].setState(true)
  }
  //追加插件信息页
  $("#Secmenu1>table>tbody>tr>td:last-child").html('<a class="Secmenuoff" id="pluginfo" target="mainFrame" href="SM_pluginfo.html">插件信息</a>');
  $("#Secmenu1>table>tbody>tr>td:last-child").addClass("Secmenutd");
  $("#Secmenu1").click(function(e){
      if(e.target.id=="pluginfo"){
          if($("#Secmenu1>table>tbody>tr a").hasClass("selected")){
            $(".selected").removeClass("selected");
          }
          $("#pluginfo").addClass("selected");
          $("#trmain>td:first-child>div").css({display:"none"});
          $("#trmain>td:first-child>br").after('' +
              '<div class="thdiv"  style="display: block;" id="pluginfomenu">' +
                '<table cellspacing="1" cellpadding="0" border="0" class="Thdmenu">' +
                  '<tbody>' +
                    '<tr>' +
                      '<td align="right" >' +
                        '<a  target="mainFrame" href="SM_pluginfo.html" class="Thdmenuoff">&nbsp;&nbsp;&nbsp;插件信息</a>' +
                      '</td>' +
                    '</tr>' +
                  '</tbody>' +
                '</table>' +
              '</div>');
          $("#f1").css({backgroundColor:"#427594"});
          $("#f1>a").addClass("selected");
      }
      else{
        $("#pluginfo").removeClass("selected");
        $("#pluginfomenu").remove();
      }
  });
  $("#Fstmenu").click(function(e){
    if(e.target.id!="Secmenu1"){
      $("#pluginfomenu").remove();
      $("#pluginfo").removeClass("selected");
      $("#pluginfomenu").remove();
    }
  });
/*
  //追加业务诊断页
  $("#Secmenu76>table>tbody>tr>td:last-child").html('<a class="Secmenuoff" id="Business" target="mainFrame" href="DD_Business.html">业务诊断</a>');
  $("#Secmenu76>table>tbody>tr>td:last-child").addClass("Secmenutd");
  $("#Secmenu76").click(function(e){
    if(e.target.id=="Business"){
      if($("#Secmenu76>table>tbody>tr a").hasClass("selected")){
        $(".selected").removeClass("selected");
      }
      $("#Business").addClass("selected");
      $("#trmain>td:first-child>div").css({display:"none"});
      $("#trmain>td:first-child>br").after('' +
          '<div class="thdiv"  style="display: block;" id="Businessmenu">' +
          '<table cellspacing="1" cellpadding="0" border="0" class="Thdmenu">' +
          '<tbody>' +
          '<tr>' +
          '<td align="right" >' +
          '<a  target="mainFrame" href="DD_Business.html" class="Thdmenuoff">&nbsp;&nbsp;&nbsp;语音诊断</a>' +
          '</td>' +
          '</tr>' +
          '</tbody>' +
          '</table>' +
          '</div>');
      //$("#f1").css({backgroundColor:"#427594"});
      //$("#f1>a").addClass("selected");
    }
    else{
      $("#Business").removeClass("selected");
      $("#Businessmenu").remove();
    }
  });
  $("#Fstmenu").click(function(e){
    if(e.target.id!="Secmenu76"){
      $("#Businessmenu").remove();
      $("#Business").removeClass("selected");
      $("#Businessmenu").remove();
    }
  });
*/
}
function xbDetectBrowser()
{
  var oldOnError = window.onerror;
  
  window.onerror = null;
  
  // work around bug in xpcdom Mozilla 0.9.1
  
  window.saveNavigator = window.navigator;
  var ua = window.navigator.userAgent.toLowerCase();

  if ((ua.indexOf('gecko') != -1)){browsernetscape =1;} 
  if ((ua.indexOf('msie') != -1) || (ua.indexOf('konqueror') != -1) || (ua.indexOf('gecko') != -1))
  {
    browserVersion = 1;
  }
  else if ((ua.indexOf('mozilla') !=-1) && (ua.indexOf('spoofer')==-1) && (ua.indexOf('compatible') == -1) && (ua.indexOf('opera')==-1)&& (ua.indexOf('webtv')==-1) && (ua.indexOf('hotjava')==-1))
  {
    browserVersion = 2;
  }
  else
  {
    browserVersion = 0;
  }
  window.onerror = oldOnError;
}